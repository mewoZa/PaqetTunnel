name: Build & Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'draft'
        type: choice
        options:
          - draft
          - prerelease
          - release

permissions:
  contents: write

jobs:
  build:
    name: Build Windows x64
    runs-on: windows-latest

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # ── Build paqet from Go source ────────────────────────────
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: paqet/go.sum

      - name: Build paqet binary
        shell: bash
        run: |
          cd paqet
          GIT_COMMIT=$(git rev-parse HEAD)
          GIT_TAG=$(git describe --tags --exact-match 2>/dev/null || echo "dev")
          BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          CGO_ENABLED=1 GOOS=windows GOARCH=amd64 go build -trimpath \
            -ldflags "-s -w -X 'paqet/cmd/version.Version=${GIT_TAG}' -X 'paqet/cmd/version.GitCommit=${GIT_COMMIT}' -X 'paqet/cmd/version.GitTag=${GIT_TAG}' -X 'paqet/cmd/version.BuildTime=${BUILD_TIME}'" \
            -o ../publish/paqet_windows_amd64.exe ./cmd/main.go
          echo "✓ paqet built ($(du -h ../publish/paqet_windows_amd64.exe | cut -f1))"

      # ── Build .NET app ────────────────────────────────────────
      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Publish PaqetTunnel (Release, single-file, self-contained)
        run: dotnet publish src\PaqetTunnel\PaqetTunnel.csproj -c Release -o publish --self-contained true -r win-x64

      # ── Download TUN dependencies ─────────────────────────────
      - name: Download tun2socks
        shell: pwsh
        run: |
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri 'https://github.com/xjasonlyu/tun2socks/releases/download/v2.6.0/tun2socks-windows-amd64.zip' -OutFile 'publish\tun2socks.zip'
          Expand-Archive -Path 'publish\tun2socks.zip' -DestinationPath 'publish' -Force
          Remove-Item 'publish\tun2socks.zip'
          if (Test-Path 'publish\tun2socks-windows-amd64.exe') { Rename-Item 'publish\tun2socks-windows-amd64.exe' 'tun2socks.exe' }
          Write-Host "✓ tun2socks.exe downloaded"

      - name: Download wintun
        shell: pwsh
        run: |
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri 'https://www.wintun.net/builds/wintun-0.14.1.zip' -OutFile 'publish\wintun.zip'
          Expand-Archive -Path 'publish\wintun.zip' -DestinationPath 'publish\wintun_extract' -Force
          Copy-Item 'publish\wintun_extract\wintun\bin\amd64\wintun.dll' 'publish\wintun.dll' -Force
          Remove-Item 'publish\wintun_extract' -Recurse -Force
          Remove-Item 'publish\wintun.zip'
          Write-Host "✓ wintun.dll downloaded"

      # ── Build InnoSetup installer ─────────────────────────────
      - name: Install InnoSetup
        shell: pwsh
        run: |
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri 'https://jrsoftware.org/download.php/is.exe' -OutFile 'is-setup.exe'
          Start-Process -FilePath 'is-setup.exe' -ArgumentList '/VERYSILENT /SUPPRESSMSGBOXES /NORESTART' -Wait
          Remove-Item 'is-setup.exe'
          Write-Host "✓ InnoSetup installed"

      - name: Build installer
        shell: pwsh
        run: |
          $iscc = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          if (!(Test-Path $iscc)) { $iscc = "$env:ProgramFiles\Inno Setup 6\ISCC.exe" }
          & $iscc "installer\PaqetSetup.iss"
          Write-Host "✓ Installer built"

      # ── List artifacts ────────────────────────────────────────
      - name: List build output
        shell: pwsh
        run: |
          Write-Host "`n=== Build Artifacts ==="
          Get-ChildItem -Path publish -File | Select-Object Name, @{N='Size(MB)';E={[math]::Round($_.Length/1MB,1)}} | Format-Table -AutoSize
          if (Test-Path "installer\Output\PaqetTunnelSetup.exe") {
            $size = [math]::Round((Get-Item "installer\Output\PaqetTunnelSetup.exe").Length/1MB, 1)
            Write-Host "Installer: PaqetTunnelSetup.exe ($size MB)"
          }

      # ── Upload artifacts ──────────────────────────────────────
      - name: Upload PaqetTunnel.exe
        uses: actions/upload-artifact@v4
        with:
          name: PaqetTunnel-win-x64
          path: publish/PaqetTunnel.exe
          retention-days: 30

      - name: Upload installer
        uses: actions/upload-artifact@v4
        with:
          name: PaqetTunnelSetup
          path: installer/Output/PaqetTunnelSetup.exe
          retention-days: 30

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: ${{ github.event.inputs.release_type == 'draft' || github.event.inputs.release_type == '' }}
          prerelease: ${{ github.event.inputs.release_type == 'prerelease' }}
          generate_release_notes: true
          files: |
            artifacts/PaqetTunnel-win-x64/PaqetTunnel.exe
            artifacts/PaqetTunnelSetup/PaqetTunnelSetup.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
